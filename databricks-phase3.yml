# Databricks Asset Bundle Configuration
# Entity Matching for S&P Capital IQ Identity Reconciliation

bundle:
  name: entity_matching

# PHASE 3: Model Deployment
# Deploys the trained model to a serving endpoint
# Prerequisites: Phases 0, 1, and 2 must be completed
# Deploy with: databricks bundle deploy -t dev --config-file databricks-phase3.yml

include:
  - resources/jobs_phase3_serving.yml

# Variables that can be overridden
variables:
  # Catalog and schema configuration
  catalog_name:
    description: Unity Catalog name
    default: entity_matching

  # Cluster configuration
  cluster_node_type:
    description: Node type for compute clusters
    default: i3.xlarge

  cluster_spark_version:
    description: Databricks Runtime version
    default: 13.3.x-scala2.12

  # Model configuration
  ditto_model_version:
    description: Ditto model version to deploy
    default: "1"

  # Job schedule
  matching_job_schedule:
    description: Cron schedule for matching job
    default: "0 0 2 * * ?" # Daily at 2 AM

# Workspace configuration
workspace:
  profile: DEFAULT
  root_path: /Workspace/Users/${workspace.current_user.userName}/.bundle/${bundle.name}/${bundle.target}

# Targets (environments)
targets:
  # Development target
  dev:
    mode: development
    default: true
    workspace:
      root_path: /Workspace/Users/${workspace.current_user.userName}/.bundle/${bundle.name}/dev
    variables:
      catalog_name: laurent_prat_entity_matching_dev
    run_as:
      user_name: ${workspace.current_user.userName}
    permissions:
      - level: CAN_MANAGE
        user_name: ${workspace.current_user.userName}
      - level: CAN_VIEW
        group_name: account users
    resources:
      model_serving_endpoints:
        ditto_matcher:
          permissions:
            - level: CAN_MANAGE
              user_name: ${workspace.current_user.userName}
            - level: CAN_QUERY
              user_name: ${workspace.current_user.userName}

  # Staging target
  staging:
    mode: production
    workspace:
      root_path: /Workspace/Shared/.bundle/${bundle.name}/staging
    variables:
      catalog_name: entity_matching_staging
    run_as:
      service_principal_name: ${var.staging_service_principal_id}
    permissions:
      - level: CAN_MANAGE
        user_name: ${workspace.current_user.userName}
      - level: CAN_VIEW
        group_name: account users
    resources:
      model_serving_endpoints:
        ditto_matcher:
          permissions:
            - level: CAN_MANAGE
              user_name: ${workspace.current_user.userName}
            - level: CAN_QUERY
              user_name: ${workspace.current_user.userName}
            - level: CAN_QUERY
              group_name: account users

  # Production target
  prod:
    mode: production
    workspace:
      root_path: /Workspace/Shared/.bundle/${bundle.name}/prod
    variables:
      catalog_name: entity_matching
      cluster_node_type: i3.2xlarge
    run_as:
      service_principal_name: ${var.prod_service_principal_id}
    permissions:
      - level: CAN_MANAGE
        user_name: ${workspace.current_user.userName}
      - level: CAN_VIEW
        group_name: account users
    resources:
      model_serving_endpoints:
        ditto_matcher:
          permissions:
            - level: CAN_MANAGE
              user_name: ${workspace.current_user.userName}
            - level: CAN_QUERY
              user_name: ${workspace.current_user.userName}
            - level: CAN_QUERY
              group_name: account users

# Sync configuration
sync:
  exclude:
    - .git
    - .venv
    - __pycache__
    - "*.pyc"
    - .env
    - .env.*
    - data/
    - models/
    - "*.log"
    - .DS_Store
